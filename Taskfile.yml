version: '3'

vars:
  AWS_INSTANCE_ID: "i-022f3394d98803da8"
  SSH_KEY: "cactus-key.pem"
  COMPOSE_FILE: "docker-compose.yml"
  PODMAN_COMPOSE:
    sh: 'command -v podman-compose >/dev/null 2>&1 && echo podman-compose || echo "python3 -m podman_compose"'
  # Puertos rootless por defecto para Nginx en producci√≥n local
  NGINX_HTTP_PORT: "8080"
  NGINX_HTTPS_PORT: "8443"

tasks:
  # ===== DESARROLLO LOCAL =====
  dev:
    desc: "üöÄ Iniciar desarrollo local completo (Podman backend + Podman frontend)"
    silent: true
    cmds:
      - task: cleanup
      - echo "üåµ Iniciando CactusDashboard en modo desarrollo con Podman para todos los servicios..."
      - task: podman:ensure
      - |
        set -e
        echo "üîß Iniciando stack completo con Podman..."
        ATT=0
        # Intentar bajar el stack primero para liberar puertos gestionados por Podman
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down || true
        until {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d; do
          ATT=$((ATT+1))
          if [ $ATT -ge 3 ]; then
            echo "‚ö†Ô∏è Fall√≥ levantar stack tras 3 intentos. Intentando reset de Podman..."
            task --silent podman:reset
            break
          fi
          echo "‚è≥ Reintentando levantar stack ($ATT/3)..."
          sleep 3
        done
        echo "‚è≥ Esperando que los servicios est√©n listos..."
        ATT=0
        until (curl -sf http://localhost:8000/api/v1/health >/dev/null 2>&1) && (curl -sf http://localhost:3000/api/health >/dev/null 2>&1); do
          ATT=$((ATT+1))
          if [ $ATT -ge 30 ]; then
            echo "‚ö†Ô∏è Los servicios no est√°n saludables a√∫n. Continuando igualmente."
            break
          fi
          sleep 3
        done
        echo "üéâ Desarrollo iniciado! Backend http://localhost:8000, Frontend http://localhost:3000"

  dev:frontend:
    desc: "üöÄ Iniciar solo frontend en localhost:3000"
    silent: true
    cmds:
      - echo "üåµ Iniciando frontend en Podman..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d frontend'

  dev:frontend:local:
    desc: "üöÄ Iniciar frontend localmente (sin Docker)"
    silent: true
    cmds:
      - echo "üåê Iniciando frontend localmente..."
      - ./scripts/start-frontend-local.sh

  dev:frontend:clean:
    desc: "üßπ Iniciar frontend con limpieza completa"
    silent: true
    cmds:
      - echo "üßπ Limpiando e iniciando frontend..."
      - task: cleanup:ports
      - cd cactus-wealth-frontend && rm -rf .next node_modules/.cache
      - cd cactus-wealth-frontend && npm install
      - ./scripts/start-frontend-local.sh

  dev:stop:
    desc: "‚èπÔ∏è Detener desarrollo local"
    silent: true
    cmds:
      - echo "üõë Deteniendo servicios locales..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down'
      - task: cleanup
      - echo "‚úÖ Servicios locales detenidos"

  dev:restart:
    desc: "üîÑ Reiniciar desarrollo local"
    silent: true
    cmds:
      - echo "üîÑ Reiniciando desarrollo local..."
      - task: dev:stop
      - sleep 3
      - task: dev

  dev:rebuild:
    desc: "üî® Rebuild completo y reiniciar"
    silent: true
    cmds:
      - echo "üî® Rebuilding servicios..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down'
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build --no-cache'
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d'
      - echo "‚úÖ Rebuild completado"

  build:
    desc: "üî® Construir todas las im√°genes"
    silent: true
    cmds:
      - echo "üî® Construyendo todas las im√°genes..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build'
      - echo "‚úÖ Im√°genes construidas"

  build:backend:
    desc: "üî® Construir imagen del backend"
    silent: true
    cmds:
      - echo "üî® Construyendo imagen del backend..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build backend'
      - echo "‚úÖ Imagen del backend construida"

  build:frontend:
    desc: "üî® Construir imagen del frontend"
    silent: true
    cmds:
      - echo "üî® Construyendo imagen del frontend..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build frontend'
      - echo "‚úÖ Imagen del frontend construida"

  build:frontend:direct:
    desc: "üî® Construir imagen del frontend directamente con podman"
    silent: true
    cmds:
      - echo "üî® Construyendo imagen del frontend directamente..."
      - task: podman:check
      - 'cd cactus-wealth-frontend && podman build -t cactusdashboard_frontend -f Dockerfile.dev .'
      - echo "‚úÖ Imagen del frontend construida directamente"

  build:frontend:verbose:
    desc: "üî® Construir imagen del frontend con salida verbose"
    silent: false
    cmds:
      - echo "üî® Construyendo imagen del frontend con salida verbose..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} --verbose -f {{.COMPOSE_FILE}} build frontend'
      - echo "‚úÖ Imagen del frontend construida"

  # ===== LOGS Y DEBUGGING =====
  logs:
    desc: "üì∫ Ver logs en vivo - todos los servicios"
    silent: true
    cmds:
      - echo "üì∫ Logs en vivo (Ctrl+C para salir)..."
      - |
        set -e
        SERVICES="cactus-backend cactus-frontend cactus-db cactus-redis cactus-nginx cactus-prometheus cactus-grafana"
        ensure_targets() {
          RUNNING_NAMES="$(podman ps --format '{{`{{.Names}}`}}')"
          TARGETS=""
          for s in $SERVICES; do
            if echo "$RUNNING_NAMES" | grep -qx "$s"; then
              TARGETS="$TARGETS $s"
            fi
          done
        }

        echo "üîé Asegurando Podman..."
        task --silent podman:ensure || true

        echo "üöÄ Asegurando stack activo (up -d idempotente)..."
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d
        echo "üîé Detectando contenedores activos..."
        sleep 5
        ensure_targets

        if [ -z "$TARGETS" ]; then
          echo "‚ùå No se pudieron iniciar los servicios. Revisa: task debug"
          exit 1
        fi

        echo "üì¶ Mostrando logs (multiplexado por contenedor)..."
        # Podman remoto no soporta m√∫ltiples contenedores en un solo logs
        # Iniciamos un stream por contenedor y los multiplexamos en esta sesi√≥n
        for name in $TARGETS; do
          echo "=== $name ==="
          (stdbuf -oL -eL podman logs -f --tail=50 "$name" | sed -u "s/^/[${name}] /") &
        done
        wait

  logs:backend:
    desc: "üì∫ Ver logs del backend"
    silent: true
    cmds:
      - echo "üì∫ Logs del backend (Ctrl+C para salir)..."
      - |
        set -e
        echo "üîé Asegurando Podman..."
        task --silent podman:ensure || true
        echo "üöÄ Asegurando backend activo..."
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d backend
        sleep 3
        echo "üì¶ Mostrando logs de: cactus-backend"
        exec podman logs -f --tail=50 cactus-backend

  logs:frontend:
    desc: "üì∫ Ver logs del frontend"
    silent: true
    cmds:
      - echo "üì∫ Logs del frontend (Ctrl+C para salir)..."
      - |
        set -e
        echo "üîé Asegurando Podman..."
        task --silent podman:ensure || true
        echo "üöÄ Asegurando frontend activo..."
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d frontend
        sleep 3
        echo "üì¶ Mostrando logs de: cactus-frontend"
        exec podman logs -f --tail=50 cactus-frontend

  logs:db:
    desc: "üì∫ Ver logs de la base de datos"
    silent: true
    cmds:
      - echo "üì∫ Logs de la base de datos (Ctrl+C para salir)..."
      - |
        set -e
        echo "üîé Asegurando Podman..."
        task --silent podman:ensure || true
        echo "üöÄ Asegurando base de datos activa..."
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d db
        sleep 3
        echo "üì¶ Mostrando logs de: cactus-db"
        exec podman logs -f --tail=50 cactus-db

  debug:
    desc: "üîç Diagn√≥stico completo del sistema"
    silent: true
    cmds:
      - echo "üîç Diagn√≥stico completo de CactusDashboard..."
      - task: status:local
      - task: health:local
      - task: ports
      - task: resources
      - task: docker:diagnose

  shell:backend:
    desc: "üêö Shell interactivo en backend"
    silent: true
    cmds:
      - echo "üêö Entrando al contenedor backend (exit para salir)..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec backend /bin/bash'

  shell:frontend:
    desc: "üêö Acceder al shell del frontend"
    silent: true
    cmds:
      - echo "üêö Accediendo al shell del frontend..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec frontend /bin/sh'

  shell:db:
    desc: "üêö Acceder al shell de la base de datos"
    silent: true
    cmds:
      - echo "üêö Accediendo al shell de la base de datos..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec db /bin/bash'

  # ===== MONITOREO Y ESTADO =====
  status:
    desc: "üìä Estado general del sistema"
    silent: true
    cmds:
      - echo "üìä Estado de CactusDashboard..."
      - task: status:local
      - task: status:aws

  status:local:
    desc: "üìä Estado de servicios locales"
    silent: true
    cmds:
      - echo "üè† Servicios locales:"
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} ps'
      - echo ""
      - echo "üåê URLs disponibles:"
      - echo "Frontend http://localhost:3000"
      - echo "Backend http://localhost:8000"
      - echo "API Docs http://localhost:8000/docs"
      - echo "Health http://localhost:8000/api/v1/health"

  status:aws:
    desc: "üìä Estado de instancia AWS"
    silent: true
    cmds:
      - echo "‚òÅÔ∏è Estado de AWS:"
      - aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].{State:State.Name,IP:PublicIpAddress,Type:InstanceType}' --output table

  health:
    desc: "üè• Verificar salud de servicios"
    silent: true
    cmds:
      - echo "üè• Verificando salud de servicios..."
      - task: health:local
      - task: health:aws

  health:local:
    desc: "üè• Salud de servicios locales"
    silent: true
    cmds:
      - echo "üè† Salud local:"
      - curl -s http://localhost:8000/api/v1/health || echo "‚ùå Backend no responde"
      - curl -s http://localhost:3000/api/health || echo "‚ùå Frontend no responde"

  health:aws:
    desc: "üè• Salud de servicios AWS"
    silent: true
    cmds:
      - echo "‚òÅÔ∏è Salud AWS:"
      - task: aws:ip
      - echo "Verificando endpoints AWS..."
      - curl -s http://$(aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text):8000/api/v1/health || echo "‚ùå Backend AWS no responde"

  ports:
    desc: "üîå Verificar puertos en uso"
    silent: true
    cmds:
      - echo "üîå Puertos en uso:"
      - lsof -i :3000 || echo "‚úÖ Puerto 3000 libre"
      - lsof -i :8000 || echo "‚úÖ Puerto 8000 libre"
      - lsof -i :5432 || echo "‚úÖ Puerto 5432 libre"
      - lsof -i :6379 || echo "‚úÖ Puerto 6379 libre"

  resources:
    desc: "üíæ Uso de recursos del sistema"
    silent: true
    cmds:
      - echo "üíæ Uso de recursos:"
      - podman stats --no-stream
      - echo ""
      - echo "üíø Espacio en disco:"
      - df -h

  # ===== AWS MANAGEMENT =====
  aws:start:
    desc: "‚ñ∂Ô∏è Iniciar instancia EC2"
    silent: true
    cmds:
      - echo "‚ñ∂Ô∏è Iniciando instancia AWS..."
      - aws ec2 start-instances --instance-ids {{.AWS_INSTANCE_ID}}
      - echo "‚è≥ Esperando que la instancia est√© lista..."
      - aws ec2 wait instance-running --instance-ids {{.AWS_INSTANCE_ID}}
      - echo "‚úÖ Instancia iniciada"
      - task: aws:ip

  aws:stop:
    desc: "‚èπÔ∏è Detener instancia (ahorrar dinero)"
    silent: true
    cmds:
      - echo "‚èπÔ∏è Deteniendo instancia AWS..."
      - aws ec2 stop-instances --instance-ids {{.AWS_INSTANCE_ID}}
      - echo "‚úÖ Instancia detenida (ahorrando dinero)"

  aws:status:
    desc: "üìä Estado de la instancia"
    silent: true
    cmds:
      - echo "üìä Estado de instancia AWS:"
      - aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].{State:State.Name,IP:PublicIpAddress,Type:InstanceType,LaunchTime:LaunchTime}' --output table

  aws:ip:
    desc: "üåê Obtener IP p√∫blica"
    silent: true
    cmds:
      - echo "üåê IP p√∫blica:"
      - aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text

  aws:costs:
    desc: "üí∞ Ver informaci√≥n de costos"
    silent: true
    cmds:
      - echo "üí∞ Informaci√≥n de costos AWS:"
      - aws ce get-cost-and-usage --time-period Start=2024-01-01,End=$(date +%Y-%m-%d) --granularity MONTHLY --metrics BlendedCost --group-by Type=DIMENSION,Key=SERVICE

  aws:ssh:
    desc: "üîë Conectar SSH a la instancia"
    silent: true
    cmds:
      - echo "üîë Conectando SSH..."
      - ssh -i {{.SSH_KEY}} ubuntu@$(aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)

  deploy:aws:
    desc: "üöÄ Desplegar a AWS"
    silent: true
    cmds:
      - echo "üöÄ Desplegando a AWS..."
      - task: aws:start
      - echo "‚è≥ Esperando que la instancia est√© lista..."
      - sleep 30
      - echo "üì¶ Desplegando aplicaci√≥n..."
      - ssh -i {{.SSH_KEY}} ubuntu@$(aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text) "cd /opt/cactus-dashboard && docker-compose pull && docker-compose up -d"
      - echo "‚úÖ Despliegue completado"
      - task: aws:ip

  # ===== OAUTH Y AUTENTICACI√ìN =====
  oauth:verify:
    desc: "üîê Verificar configuraci√≥n OAuth"
    silent: true
    cmds:
      - echo "üîê Verificando configuraci√≥n OAuth..."
      - test -n "$GOOGLE_CLIENT_ID" && echo "‚úÖ GOOGLE_CLIENT_ID configurado" || echo "‚ùå GOOGLE_CLIENT_ID no configurado"
      - test -n "$GOOGLE_CLIENT_SECRET" && echo "‚úÖ GOOGLE_CLIENT_SECRET configurado" || echo "‚ùå GOOGLE_CLIENT_SECRET no configurado"
      - test -n "$NEXTAUTH_URL" && echo "‚úÖ NEXTAUTH_URL configurado" || echo "‚ùå NEXTAUTH_URL no configurado"

  oauth:update:
    desc: "üîÑ Actualizar credenciales OAuth"
    silent: true
    cmds:
      - echo "üîÑ Actualizando credenciales OAuth..."
      - echo "Por favor, actualiza las variables de entorno:"
      - echo "  GOOGLE_CLIENT_ID=tu_nuevo_client_id"
      - echo "  GOOGLE_CLIENT_SECRET=tu_nuevo_client_secret"
      - echo "  NEXTAUTH_URL=http://localhost:3000"

  oauth:diagnose:
    desc: "üîç Diagn√≥stico completo de OAuth"
    silent: true
    cmds:
      - echo "üîç Diagn√≥stico completo de OAuth..."
      - task: oauth:verify
      - echo ""
      - echo "üìã Verificando endpoints:"
      - curl -s http://localhost:3000/api/auth/providers || echo "‚ùå Endpoint de providers no disponible"
      - echo ""
      - echo "üîß Configuraci√≥n NextAuth:"
      - test -f "cactus-wealth-frontend/.env.local" && echo "‚úÖ .env.local existe" || echo "‚ùå .env.local no existe"

  oauth:test:
    desc: "üß™ Probar configuraci√≥n OAuth"
    silent: true
    cmds:
      - echo "üß™ Probando configuraci√≥n OAuth..."
      - task: oauth:verify
      - echo ""
      - echo "üåê Abriendo p√°gina de login..."
      - open http://localhost:3000/auth/login || echo "‚ùå No se pudo abrir el navegador"

  # ===== LIMPIEZA Y MANTENIMIENTO =====
  cleanup:
    desc: "üßπ Limpieza completa (puertos + cach√©)"
    silent: true
    cmds:
      - echo "üßπ Limpieza completa..."
      - task: cleanup:ports
      - task: cleanup:frontend
      - task: cleanup:backend
      - echo "‚úÖ Limpieza completada"

  cleanup:ports:
    desc: "üîå Limpiar puertos ocupados"
    silent: true
    cmds:
      - echo "üîå Limpiando puertos..."
      - |
        # Si la Podman Machine est√° corriendo, no matar procesos del host (evita matar gvproxy/qemu)
        if podman machine list 2>/dev/null | grep -q "cactus-dashboard.*Currently running"; then
          echo "‚ÑπÔ∏è Podman Machine en ejecuci√≥n. Saltando kill de puertos del host."
          echo "   Usa podman-compose down para liberar puertos gestionados por contenedores."
        else
          lsof -ti:3000 | xargs kill -9 2>/dev/null || echo "‚úÖ Puerto 3000 libre"
          lsof -ti:8000 | xargs kill -9 2>/dev/null || echo "‚úÖ Puerto 8000 libre"
          lsof -ti:5432 | xargs kill -9 2>/dev/null || echo "‚úÖ Puerto 5432 libre"
          lsof -ti:6379 | xargs kill -9 2>/dev/null || echo "‚úÖ Puerto 6379 libre"
        fi

  cleanup:frontend:
    desc: "üßπ Limpiar cach√© del frontend"
    silent: true
    cmds:
      - |
        [ "${FORCE}" = "1" ] || { echo "[SAFEGUARD] agrega FORCE=1 para proceder (saltando sin error)"; exit 0; }
      - echo "üßπ Limpiando cach√© y artefactos del frontend..."
      - cd cactus-wealth-frontend && rm -rf .next node_modules/.cache coverage playwright-report test-results deadcode-report.json logs 2>/dev/null || true

  cleanup:backend:
    desc: "üßπ Limpiar cach√© del backend"
    silent: true
    cmds:
      - |
        [ "${FORCE}" = "1" ] || { echo "[SAFEGUARD] agrega FORCE=1 para proceder (saltando sin error)"; exit 0; }
      - echo "üßπ Limpiando cach√© y artefactos del backend..."
      - cd cactus-wealth-backend && rm -rf __pycache__ .pytest_cache .mypy_cache .ruff_cache htmlcov .coverage* logs 2>/dev/null || true

  cleanup:docker:
    desc: "üê≥ Limpiar Podman (im√°genes, contenedores)"
    silent: true
    cmds:
      - echo "üê≥ Limpiando Podman..."
      - podman system prune -f
      - podman volume prune -f
      - echo "‚úÖ Podman limpio"

  # ===== PODMAN =====
  podman:check:
    desc: "üê≥ Verificar Podman"
    silent: true
    cmds:
      - echo "üê≥ Verificando Podman..."
      - podman info >/dev/null 2>&1 && echo "‚úÖ Podman funcionando" || (echo "‚ùå Podman no funciona" && exit 1)

  podman:ensure:
    desc: "üîß Asegurar que Podman est√© disponible"
    silent: true
    cmds:
      - echo "üîß Asegurando disponibilidad de Podman..."
      - |
        if ! podman machine list | grep -q "cactus-dashboard"; then
          echo "üì¶ Creando m√°quina Podman..."
          podman machine init --cpus 4 --memory 8192 --disk-size 50 cactus-dashboard
        fi
      - |
        if ! podman machine list | grep -q "cactus-dashboard.*Currently running"; then
          echo "üöÄ Iniciando m√°quina Podman..."
          podman machine start cactus-dashboard
        else
          echo "‚úÖ M√°quina ya est√° ejecut√°ndose"
        fi
      - echo "‚úÖ Podman disponible"

  podman:verify:
    desc: "‚úÖ Verificar configuraci√≥n de Podman"
    silent: true
    cmds:
      - echo "‚úÖ Verificando configuraci√≥n de Podman..."
      - task: podman:check
      - echo ""
      - echo "üìä Informaci√≥n de la m√°quina:"
      - podman machine list
      - echo ""
      - echo "üîß Configuraci√≥n:"
      - podman system connection list
      - echo ""
      - echo "üíæ Recursos disponibles:"
      - podman system df

  podman:status:
    desc: "üìä Estado de la m√°quina Podman"
    silent: true
    cmds:
      - echo "üìä Estado de la m√°quina Podman:"
      - podman machine list
      - echo ""
      - echo "üîß Conexiones activas:"
      - podman system connection list

  podman:start:
    desc: "üöÄ Iniciar m√°quina Podman"
    silent: true
    cmds:
      - echo "üöÄ Iniciando m√°quina Podman..."
      - |
        if podman machine list | grep -q "cactus-dashboard.*Currently running"; then
          echo "‚úÖ M√°quina ya est√° ejecut√°ndose"
        else
          podman machine start cactus-dashboard
          echo "‚úÖ M√°quina iniciada"
        fi
      - task: podman:status

  podman:stop:
    desc: "‚èπÔ∏è Detener m√°quina Podman"
    silent: true
    cmds:
      - echo "‚èπÔ∏è Deteniendo m√°quina Podman..."
      - podman machine stop cactus-dashboard
      - echo "‚úÖ M√°quina detenida"

  podman:restart:
    desc: "üîÑ Reiniciar m√°quina Podman"
    silent: true
    cmds:
      - echo "üîÑ Reiniciando m√°quina Podman..."
      - task: podman:stop
      - task: podman:start

  podman:helper:install:
    desc: "üîó Instalar podman-mac-helper (Docker socket compatibility)"
    silent: true
    cmds:
      - echo "üîó Instalando podman-mac-helper..."
      - |
        HELPER="$(brew --prefix podman)/bin/podman-mac-helper";
        if [ -x "$HELPER" ]; then
          echo "Usando $HELPER";
        else
          echo "‚ùå podman-mac-helper no encontrado";
          exit 1;
        fi
        if sudo -n "$HELPER" install; then
          echo "‚úÖ mac-helper instalado";
        else
          echo "‚ö†Ô∏è  Se requiere sudo interactivo. Ejecuta manualmente: sudo $HELPER install";
          exit 0;
        fi
      - echo "üîÑ Reiniciando m√°quina Podman para aplicar cambios..."
      - podman machine stop cactus-dashboard || true
      - podman machine start cactus-dashboard
      - echo "‚úÖ podman-mac-helper instalado"

  podman:helper:status:
    desc: "üîó Estado de compatibilidad Docker API (mac-helper)"
    silent: true
    cmds:
      - |
        echo "üîó Verificando estado del socket Docker API...";
        if test -S /var/run/docker.sock; then
          echo "‚úÖ /var/run/docker.sock presente (compatibilidad activa)";
        else
          echo "‚ÑπÔ∏è /var/run/docker.sock no est√° enlazado";
        fi
        if [ -z "$DOCKER_HOST" ]; then
          echo "üìå DOCKER_HOST actual: no definido";
        else
          echo "üìå DOCKER_HOST actual: $DOCKER_HOST";
        fi
        echo "üí° Si no est√° activo: task podman:helper:install"

  podman:helper:uninstall:
    desc: "üîó Desinstalar podman-mac-helper"
    silent: true
    cmds:
      - echo "üîó Desinstalando podman-mac-helper..."
      - |
        HELPER="$(brew --prefix podman)/bin/podman-mac-helper";
        if sudo -n "$HELPER" uninstall; then
          echo "‚úÖ mac-helper desinstalado";
        else
          echo "‚ö†Ô∏è  Se requiere sudo interactivo. Ejecuta manualmente: sudo $HELPER uninstall";
          exit 0;
        fi
      - echo "üîÑ Reiniciando m√°quina Podman para aplicar cambios..."
      - podman machine stop cactus-dashboard || true
      - podman machine start cactus-dashboard
      - echo "‚úÖ podman-mac-helper desinstalado"

  podman:diagnose:
    desc: "üîç Diagn√≥stico completo de Podman"
    silent: true
    cmds:
      - echo "üîç Diagn√≥stico completo de Podman..."
      - task: podman:check
      - echo ""
      - echo "üìä Estado de contenedores:"
      - podman ps -a
      - echo ""
      - echo "üíæ Uso de recursos:"
      - podman system df
      - echo ""
      - echo "üîß Configuraci√≥n de red:"
      - podman network ls
      - echo ""
      - echo "üíø Vol√∫menes:"
      - podman volume ls

  podman:cleanup:
    desc: "üßπ Limpiar recursos de Podman"
    silent: true
    cmds:
      - echo "üßπ Limpiando recursos de Podman..."
      - podman system prune -f
      - podman volume prune -f
      - podman image prune -f
      - echo "‚úÖ Limpieza completada"

  podman:reset:
    desc: "üîÑ Reset completo de Podman"
    silent: true
    cmds:
      - echo "üîÑ Reset completo de Podman..."
      - echo "‚èπÔ∏è Intentando detener stack (si aplica)..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down || true'
      - task: podman:cleanup
      - podman machine stop cactus-dashboard 2>/dev/null || echo "‚úÖ M√°quina ya detenida"
      - podman machine rm cactus-dashboard 2>/dev/null || echo "‚úÖ M√°quina ya eliminada"
      - podman machine init --cpus 4 --memory 8192 --disk-size 50 cactus-dashboard
      - podman machine start cactus-dashboard
      - echo "‚úÖ Reset completado"

  # ===== DOCKER (COMPATIBILIDAD) =====
  docker:check:
    desc: "üê≥ Verificar Docker (alias de Podman)"
    silent: true
    cmds:
      - echo "üê≥ Verificando Docker (alias de Podman)..."
      - docker info >/dev/null 2>&1 && echo "‚úÖ Docker (Podman) funcionando" || (echo "‚ùå Docker (Podman) no funciona" && exit 1)

  docker:diagnose:
    desc: "üîç Diagn√≥stico de Docker (alias de Podman)"
    silent: true
    cmds:
      - echo "üîç Diagn√≥stico de Docker (alias de Podman)..."
      - task: docker:check
      - echo ""
      - echo "üìä Estado de contenedores:"
      - docker ps -a
      - echo ""
      - echo "üíæ Uso de recursos:"
      - docker system df

  # ===== TESTING =====
  test:all:
    desc: "üß™ Ejecutar todos los tests"
    silent: true
    cmds:
      - echo "üß™ Ejecutando todos los tests..."
      - task: test:backend
      - task: test:frontend

  test:backend:
    desc: "üß™ Tests del backend"
    silent: true
    cmds:
      - echo "üß™ Tests del backend..."
      - |
        cd cactus-wealth-backend && \
        (poetry --version >/dev/null 2>&1 || pip3 install -q poetry) && \
        poetry install --no-root && \
        poetry run pytest tests/ -v

  test:frontend:
    desc: "üß™ Tests del frontend"
    silent: true
    cmds:
      - echo "üß™ Tests del frontend (Vitest CI)..."
      - cd cactus-wealth-frontend && npm run test:ci

  test:integration:
    desc: "üß™ Tests de integraci√≥n"
    silent: true
    cmds:
      - echo "üß™ Tests de integraci√≥n..."
      - task: dev:stop
      - task: dev
      - sleep 30
      - cd cactus-wealth-backend && poetry run pytest tests/integration/ -v

  test:e2e:
    desc: "üß™ Tests end-to-end"
    silent: true
    cmds:
      - echo "üß™ Tests end-to-end..."
      - cd cactus-wealth-frontend && npm run -s e2e:full

  up:smoke:
    desc: "üö¨ Levantar stack m√≠nimo y correr E2E smoke (Chromium)"
    silent: true
    cmds:
      - |
          echo "E2E smoke: stack minimo (db+backend+frontend) con Podman y Playwright (Chromium)"
          task --silent podman:ensure || true
          set -e
          export E2E_MODE=${E2E_MODE:-1}
          export E2E_SECRET=${E2E_SECRET:-dev-secret}
          export BACKEND_URL=${BACKEND_URL:-http://localhost:8000}
          echo "E2E_SECRET=${E2E_SECRET} (solo local)"
          {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d db redis backend frontend
          echo "Esperando health de servicios..."
          ATT=0
          until (curl -sf http://localhost:8000/api/v1/health >/dev/null 2>&1) && (curl -sf http://localhost:3000/api/health >/dev/null 2>&1); do
            ATT=$((ATT+1))
            if [ $ATT -ge 40 ]; then
              echo "Timeout esperando salud de servicios"; exit 1;
            fi
            sleep 3
          done
          echo "Servicios saludables"
          echo "Ejecutando Playwright smoke (@smoke, Chromium)"
          cd cactus-wealth-frontend
          npm run -s e2e:install
          E2E_MODE=$E2E_MODE E2E_SECRET=$E2E_SECRET BACKEND_URL=$BACKEND_URL BASE_URL=http://localhost:3000 npm run -s e2e:smoke

  # ===== UTILIDADES =====
  seed:god:
    desc: "üå± Crear usuario GOD 'gio' en backend (contenedor)"
    silent: true
    cmds:
      - echo "üë§ Creando usuario GOD en backend..."
      - |
        set -e
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d backend db redis
        echo "‚è≥ Esperando health del backend..."
        ATT=0
        until (curl -sf http://localhost:8000/api/v1/health >/dev/null 2>&1); do
          ATT=$((ATT+1)); if [ $ATT -ge 40 ]; then echo "Timeout esperando backend"; exit 1; fi; sleep 3; done
        echo "üöÄ Ejecutando script create_god_user.py"
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec backend python scripts/create_god_user.py

  dev:onboard:
    desc: "üöÄ Levantar stack y preparar usuarios base (GOD)"
    silent: true
    cmds:
      - echo "üöÄ Iniciando onboarding de desarrollo..."
      - task: dev
      - echo "‚è≥ Verificando salud de servicios..."
      - |
        ATT=0
        until (curl -sf http://localhost:8000/api/v1/health >/dev/null 2>&1) && (curl -sf http://localhost:3000/api/health >/dev/null 2>&1); do
          ATT=$((ATT+1)); if [ $ATT -ge 40 ]; then echo "Timeout esperando servicios"; exit 1; fi; sleep 3; done
      - task: seed:god
      - |
        echo "‚úÖ Onboarding listo. Credenciales GOD: gio / gigi123"
  setup:
    desc: "‚öôÔ∏è Configuraci√≥n inicial"
    silent: true
    cmds:
      - echo "‚öôÔ∏è Configuraci√≥n inicial de CactusDashboard..."
      - task: setup:podman-compose
      - |
        # Preferir Podman; si hay docker CLI, tambi√©n sirve (alias o real)
        if task --silent podman:check; then
          echo "‚úÖ Podman listo (setup)";
        else
          echo "‚ÑπÔ∏è Podman no disponible, intentando docker...";
          task --silent docker:check || { echo "‚ùå Ni Podman ni Docker disponibles"; exit 1; };
        fi
      - echo "üì¶ Instalando dependencias del backend con Poetry..."
      - cd cactus-wealth-backend && (poetry --version >/dev/null 2>&1 || pip3 install -q poetry)
      - cd cactus-wealth-backend && poetry install --no-root
      - cd cactus-wealth-frontend && npm install
      - echo "‚úÖ Configuraci√≥n completada"

  setup:podman-compose:
    desc: "üì¶ Instalar y configurar podman-compose"
    silent: true
    cmds:
      - echo "üì¶ Verificando podman-compose..."
      - |
        if {{.PODMAN_COMPOSE}} --version >/dev/null 2>&1; then
          echo "‚úÖ podman-compose disponible";
        else
          echo "üîß Instalando podman-compose v√≠a pip...";
          pip3 install podman-compose >/dev/null 2>&1 || pip install podman-compose;
          echo "üîó Verificando funcionamiento tras la instalaci√≥n...";
          python3 -m podman_compose --version || exit 1;
        fi
      - echo "üîó Verificando funcionamiento..."
      - '{{.PODMAN_COMPOSE}} --version'

  validate:
    desc: "‚úÖ Validar configuraci√≥n"
    silent: true
    cmds:
      - echo "‚úÖ Validando configuraci√≥n..."
      - task: docker:check
      - task: oauth:verify
      - echo "‚úÖ Configuraci√≥n v√°lida"

  # ===== AYUDA =====
  help:
    desc: "‚ùì Documentaci√≥n completa"
    silent: true
    cmds:
      - echo "üåµ CactusDashboard - Sistema de Comandos TASK"
      - echo ""
      - echo "üìö Documentaci√≥n completa:"
      - echo "  DOCUMENTATION.md - Gu√≠a completa del proyecto"
      - echo ""
      - echo "üöÄ Comandos principales:"
      - echo "  task dev              - Iniciar desarrollo completo"
      - echo "  task aws:start        - Iniciar instancia AWS"
      - echo "  task logs             - Ver logs en vivo"
      - echo "  task debug            - Diagn√≥stico completo"
      - echo ""
      - echo "‚ùì Para m√°s ayuda:"
      - echo "  task --list           - Lista de todos los comandos"
      - echo "  task help:quick       - Ayuda r√°pida"

  help:quick:
    desc: "‚ö° Ayuda r√°pida (comandos esenciales)"
    silent: true
    cmds:
      - echo "‚ö° Comandos esenciales:"
      - echo ""
      - echo "üöÄ Desarrollo:"
      - echo "  task dev              - Iniciar desarrollo"
      - echo "  task dev:stop         - Detener desarrollo"
      - echo "  task logs             - Ver logs"
      - echo ""
      - echo "‚òÅÔ∏è AWS:"
      - echo "  task aws:start        - Iniciar instancia"
      - echo "  task aws:stop         - Detener instancia"
      - echo "  task aws:status       - Ver estado"
      - echo ""
      - echo "üîß Utilidades:"
      - echo "  task debug            - Diagn√≥stico"
      - echo "  task cleanup          - Limpiar todo"
      - echo "  task help             - Ayuda completa"

  verify:
    desc: "‚úÖ Verificar stack local (prod + monitoring)"
    silent: true
    cmds:
      - echo "‚úÖ Verificando stack local..."
      - 'curl -sf http://localhost/ | head -n 1 || curl -sf http://localhost:8080/ | head -n 1 || echo "‚ùå Nginx no responde"'
      - 'curl -sf http://localhost/api/v1/health || curl -sf http://localhost:8080/api/v1/health || echo "‚ùå Backend (proxy) no responde"'
      - 'curl -sf http://localhost:9090/-/healthy || echo "‚ùå Prometheus no responde"'
      - 'curl -sf http://localhost:3001/login | head -n 1 || echo "‚ùå Grafana no responde"'

  # ===== PRODUCCI√ìN LOCAL (NGINX + FRONTEND PROD) =====
  prod:start:
    desc: "üöÄ Iniciar perfil producci√≥n local (nginx+frontend_prod) en 8080/8443"
    silent: true
    cmds:
      - echo "üåµ Iniciando producci√≥n local (Nginx {{.NGINX_HTTP_PORT}}/{{.NGINX_HTTPS_PORT}})..."
      - task: podman:ensure
      - echo "‚èπÔ∏è Deteniendo frontend dev si est√° activo..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} stop frontend || true'
      - echo "üöÄ Levantando servicios base (db, redis, backend)..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d db redis backend'
      - echo "üöÄ Levantando frontend_prod + nginx (perfil production)..."
      - 'NGINX_HTTP_PORT={{.NGINX_HTTP_PORT}} NGINX_HTTPS_PORT={{.NGINX_HTTPS_PORT}} {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} --profile production up -d frontend_prod nginx'
      - echo "‚è≥ Esperando readiness de Nginx y backend v√≠a proxy..."
      - |
        ATT=0
        until (curl -sf http://localhost:{{.NGINX_HTTP_PORT}}/ >/dev/null 2>&1) && (curl -sf http://localhost:{{.NGINX_HTTP_PORT}}/api/v1/health >/dev/null 2>&1); do
          ATT=$((ATT+1)); if [ $ATT -ge 40 ]; then echo "Timeout esperando Nginx/backend"; break; fi; sleep 3;
        done

  prod:stop:
    desc: "‚èπÔ∏è Detener perfil producci√≥n local (nginx+frontend_prod)"
    silent: true
    cmds:
      - echo "‚èπÔ∏è Deteniendo servicios de producci√≥n (nginx, frontend_prod, backend)..."
      - 'NGINX_HTTP_PORT={{.NGINX_HTTP_PORT}} NGINX_HTTPS_PORT={{.NGINX_HTTPS_PORT}} {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} --profile production stop nginx frontend_prod || true'
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} stop backend || true'
      - echo "‚úÖ Producci√≥n local detenida"

  prod:restart:
    desc: "üîÑ Reiniciar perfil producci√≥n local"
    silent: true
    cmds:
      - task: prod:stop
      - sleep 2
      - task: prod:start

  prod:status:
    desc: "üìä Estado de producci√≥n local"
    silent: true
    cmds:
      - echo "üìä Estado (production profile):"
      - 'NGINX_HTTP_PORT={{.NGINX_HTTP_PORT}} NGINX_HTTPS_PORT={{.NGINX_HTTPS_PORT}} {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} ps'

  # ===== MONITORING (PROMETHEUS + GRAFANA) =====
  monitoring:start:
    desc: "üìà Iniciar perfil monitoring (Prometheus 9090, Grafana 3001)"
    silent: true
    cmds:
      - echo "üìà Iniciando monitoring..."
      - task: podman:ensure
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} --profile monitoring up -d'
      - echo "‚è≥ Esperando salud de Prometheus..."
      - 'ATT=0; until (curl -sf http://localhost:9090/-/healthy >/dev/null 2>&1); do ATT=$((ATT+1)); if [ $ATT -ge 40 ]; then echo "Timeout esperando Prometheus"; break; fi; sleep 2; done'

  monitoring:stop:
    desc: "‚èπÔ∏è Detener perfil monitoring"
    silent: true
    cmds:
      - echo "‚èπÔ∏è Deteniendo monitoring..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} --profile monitoring stop'
      - echo "‚úÖ Monitoring detenido"

  monitoring:status:
    desc: "üìä Estado de monitoring"
    silent: true
    cmds:
      - echo "üìä Estado (monitoring profile):"
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} ps'

  prod:logs:
    desc: "üì∫ Logs en vivo de producci√≥n (nginx + frontend_prod)"
    silent: true
    cmds:
      - echo "üì∫ Logs de producci√≥n (Ctrl+C para salir)..."
      - task: podman:ensure
      - 'NGINX_HTTP_PORT={{.NGINX_HTTP_PORT}} NGINX_HTTPS_PORT={{.NGINX_HTTPS_PORT}} {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} --profile production up -d nginx frontend_prod'
      - |
        echo "=== cactus-nginx ===" &
        (stdbuf -oL -eL podman logs -f --tail=100 cactus-nginx | sed -u "s/^/[cactus-nginx] /") &
        echo "=== cactus-frontend-prod ===" &
        (stdbuf -oL -eL podman logs -f --tail=100 cactus-frontend-prod | sed -u "s/^/[cactus-frontend-prod] /") &
        wait

  monitoring:logs:
    desc: "üì∫ Logs en vivo de monitoring (Prometheus + Grafana)"
    silent: true
    cmds:
      - echo "üì∫ Logs de monitoring (Ctrl+C para salir)..."
      - task: podman:ensure
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} --profile monitoring up -d'
      - |
        echo "=== cactus-prometheus ===" &
        (stdbuf -oL -eL podman logs -f --tail=100 cactus-prometheus | sed -u "s/^/[cactus-prometheus] /") &
        echo "=== cactus-grafana ===" &
        (stdbuf -oL -eL podman logs -f --tail=100 cactus-grafana | sed -u "s/^/[cactus-grafana] /") &
        wait

  # Nota: tarea prod:ssh removida temporalmente mientras se corrige el YAML

