version: '3'

vars:
  AWS_INSTANCE_ID: "i-022f3394d98803da8"
  SSH_KEY: "cactus-key.pem"
  COMPOSE_FILE: "docker-compose.yml"
  PODMAN_COMPOSE: "podman-compose"

tasks:
  # ===== DESARROLLO LOCAL =====
  dev:
    desc: "ğŸš€ Iniciar desarrollo local completo (Podman backend + Podman frontend)"
    silent: true
    cmds:
      - task: cleanup
      - echo "ğŸŒµ Iniciando CactusDashboard en modo desarrollo con Podman para todos los servicios..."
      - task: podman:ensure
      - |
        set -e
        echo "ğŸ”§ Iniciando stack completo con Podman..."
        ATT=0
        # Intentar bajar el stack primero para liberar puertos gestionados por Podman
        {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down || true
        until {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d; do
          ATT=$((ATT+1))
          if [ $ATT -ge 3 ]; then
            echo "âš ï¸ FallÃ³ levantar stack tras 3 intentos. Intentando reset de Podman..."
            task --silent podman:reset
            break
          fi
          echo "â³ Reintentando levantar stack ($ATT/3)..."
          sleep 3
        done
        echo "â³ Esperando que los servicios estÃ©n listos..."
        ATT=0
        until (curl -sf http://localhost:8000/health >/dev/null 2>&1) && (curl -sf http://localhost:3000/api/health >/dev/null 2>&1); do
          ATT=$((ATT+1))
          if [ $ATT -ge 30 ]; then
            echo "âš ï¸ Los servicios no estÃ¡n saludables aÃºn. Continuando igualmente."
            break
          fi
          sleep 3
        done
        echo "ğŸ‰ Desarrollo iniciado! Backend http://localhost:8000, Frontend http://localhost:3000"

  dev:frontend:
    desc: "ğŸš€ Iniciar solo frontend en localhost:3000"
    silent: true
    cmds:
      - echo "ğŸŒµ Iniciando frontend en Podman..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d frontend'

  dev:frontend:local:
    desc: "ğŸš€ Iniciar frontend localmente (sin Docker)"
    silent: true
    cmds:
      - echo "ğŸŒ Iniciando frontend localmente..."
      - ./scripts/start-frontend-local.sh

  dev:frontend:clean:
    desc: "ğŸ§¹ Iniciar frontend con limpieza completa"
    silent: true
    cmds:
      - echo "ğŸ§¹ Limpiando e iniciando frontend..."
      - task: cleanup:ports
      - cd cactus-wealth-frontend && rm -rf .next node_modules/.cache
      - cd cactus-wealth-frontend && npm install
      - ./scripts/start-frontend-local.sh

  dev:stop:
    desc: "â¹ï¸ Detener desarrollo local"
    silent: true
    cmds:
      - echo "ğŸ›‘ Deteniendo servicios locales..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down'
      - task: cleanup
      - echo "âœ… Servicios locales detenidos"

  dev:restart:
    desc: "ğŸ”„ Reiniciar desarrollo local"
    silent: true
    cmds:
      - echo "ğŸ”„ Reiniciando desarrollo local..."
      - task: dev:stop
      - sleep 3
      - task: dev

  dev:rebuild:
    desc: "ğŸ”¨ Rebuild completo y reiniciar"
    silent: true
    cmds:
      - echo "ğŸ”¨ Rebuilding servicios..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down'
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build --no-cache'
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d'
      - echo "âœ… Rebuild completado"

  build:
    desc: "ğŸ”¨ Construir todas las imÃ¡genes"
    silent: true
    cmds:
      - echo "ğŸ”¨ Construyendo todas las imÃ¡genes..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build'
      - echo "âœ… ImÃ¡genes construidas"

  build:backend:
    desc: "ğŸ”¨ Construir imagen del backend"
    silent: true
    cmds:
      - echo "ğŸ”¨ Construyendo imagen del backend..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build backend'
      - echo "âœ… Imagen del backend construida"

  build:frontend:
    desc: "ğŸ”¨ Construir imagen del frontend"
    silent: true
    cmds:
      - echo "ğŸ”¨ Construyendo imagen del frontend..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} build frontend'
      - echo "âœ… Imagen del frontend construida"

  build:frontend:direct:
    desc: "ğŸ”¨ Construir imagen del frontend directamente con podman"
    silent: true
    cmds:
      - echo "ğŸ”¨ Construyendo imagen del frontend directamente..."
      - task: podman:check
      - 'cd cactus-wealth-frontend && podman build -t cactusdashboard_frontend -f Dockerfile.dev .'
      - echo "âœ… Imagen del frontend construida directamente"

  build:frontend:verbose:
    desc: "ğŸ”¨ Construir imagen del frontend con salida verbose"
    silent: false
    cmds:
      - echo "ğŸ”¨ Construyendo imagen del frontend con salida verbose..."
      - task: podman:check
      - '{{.PODMAN_COMPOSE}} --verbose -f {{.COMPOSE_FILE}} build frontend'
      - echo "âœ… Imagen del frontend construida"

  # ===== LOGS Y DEBUGGING =====
  logs:
    desc: "ğŸ“º Ver logs en vivo - todos los servicios"
    silent: true
    cmds:
      - echo "ğŸ“º Logs en vivo (Ctrl+C para salir)..."
      - |
        set -e
        SERVICES="cactus-backend cactus-frontend cactus-db cactus-redis cactus-nginx cactus-prometheus cactus-grafana"
        ensure_targets() {
          RUNNING_NAMES="$(podman ps --format '{{.Names}}')"
          TARGETS=""
          for s in $SERVICES; do
            if echo "$RUNNING_NAMES" | grep -qx "$s"; then
              TARGETS="$TARGETS $s"
            fi
          done
        }

        echo "ğŸ” Verificando Podman..."
        if ! podman info >/dev/null 2>&1; then
          echo "ğŸ”§ Podman no disponible. Intentando iniciar mÃ¡quina..."
          task --silent podman:ensure || true
        fi

        echo "ğŸ” Detectando contenedores activos..."
        ensure_targets
        if [ -z "$TARGETS" ]; then
          echo "ğŸš€ No hay contenedores. Iniciando stack con podman-compose..."
          {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d
          echo "â³ Esperando inicio de servicios..."
          sleep 8
          ensure_targets
        fi

        if [ -z "$TARGETS" ]; then
          echo "âŒ No se pudieron iniciar los servicios. Revisa: task debug"
          exit 1
        fi

        echo "ğŸ“¦ Mostrando logs de:$TARGETS"
        # Usamos podman logs para evitar la limitaciÃ³n con mÃºltiples contenedores en modo remoto
        exec podman logs -f --tail=50 $TARGETS

  logs:backend:
    desc: "ğŸ“º Ver logs del backend"
    silent: true
    cmds:
      - echo "ğŸ“º Logs del backend (Ctrl+C para salir)..."
      - |
        set -e
        echo "ğŸ” Verificando Podman..."
        podman info >/dev/null 2>&1 || task --silent podman:ensure || true
        if ! podman ps --format '{{.Names}}' | grep -qx 'cactus-backend'; then
          echo "ğŸš€ Iniciando backend con podman-compose..."
          {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d backend
          sleep 5
        fi
        echo "ğŸ“¦ Mostrando logs de: cactus-backend"
        exec podman logs -f --tail=50 cactus-backend

  logs:frontend:
    desc: "ğŸ“º Ver logs del frontend"
    silent: true
    cmds:
      - echo "ğŸ“º Logs del frontend (Ctrl+C para salir)..."
      - |
        set -e
        echo "ğŸ” Verificando Podman..."
        podman info >/dev/null 2>&1 || task --silent podman:ensure || true
        if ! podman ps --format '{{.Names}}' | grep -qx 'cactus-frontend'; then
          echo "ğŸš€ Iniciando frontend con podman-compose..."
          {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d frontend
          sleep 5
        fi
        echo "ğŸ“¦ Mostrando logs de: cactus-frontend"
        exec podman logs -f --tail=50 cactus-frontend

  logs:db:
    desc: "ğŸ“º Ver logs de la base de datos"
    silent: true
    cmds:
      - echo "ğŸ“º Logs de la base de datos (Ctrl+C para salir)..."
      - |
        set -e
        echo "ğŸ” Verificando Podman..."
        podman info >/dev/null 2>&1 || task --silent podman:ensure || true
        if ! podman ps --format '{{.Names}}' | grep -qx 'cactus-db'; then
          echo "ğŸš€ Iniciando base de datos con podman-compose..."
          {{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} up -d db
          sleep 5
        fi
        echo "ğŸ“¦ Mostrando logs de: cactus-db"
        exec podman logs -f --tail=50 cactus-db

  debug:
    desc: "ğŸ” DiagnÃ³stico completo del sistema"
    silent: true
    cmds:
      - echo "ğŸ” DiagnÃ³stico completo de CactusDashboard..."
      - task: status:local
      - task: health:local
      - task: ports
      - task: resources
      - task: docker:diagnose

  shell:backend:
    desc: "ğŸš Shell interactivo en backend"
    silent: true
    cmds:
      - echo "ğŸš Entrando al contenedor backend (exit para salir)..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec backend /bin/bash'

  shell:frontend:
    desc: "ğŸš Acceder al shell del frontend"
    silent: true
    cmds:
      - echo "ğŸš Accediendo al shell del frontend..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec frontend /bin/sh'

  shell:db:
    desc: "ğŸš Acceder al shell de la base de datos"
    silent: true
    cmds:
      - echo "ğŸš Accediendo al shell de la base de datos..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} exec db /bin/bash'

  # ===== MONITOREO Y ESTADO =====
  status:
    desc: "ğŸ“Š Estado general del sistema"
    silent: true
    cmds:
      - echo "ğŸ“Š Estado de CactusDashboard..."
      - task: status:local
      - task: status:aws

  status:local:
    desc: "ğŸ“Š Estado de servicios locales"
    silent: true
    cmds:
      - echo "ğŸ  Servicios locales:"
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} ps'
      - echo ""
      - echo "ğŸŒ URLs disponibles:"
      - echo "Frontend http://localhost:3000"
      - echo "Backend http://localhost:8000"
      - echo "API Docs http://localhost:8000/docs"
      - echo "Health http://localhost:8000/health"

  status:aws:
    desc: "ğŸ“Š Estado de instancia AWS"
    silent: true
    cmds:
      - echo "â˜ï¸ Estado de AWS:"
      - aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].{State:State.Name,IP:PublicIpAddress,Type:InstanceType}' --output table

  health:
    desc: "ğŸ¥ Verificar salud de servicios"
    silent: true
    cmds:
      - echo "ğŸ¥ Verificando salud de servicios..."
      - task: health:local
      - task: health:aws

  health:local:
    desc: "ğŸ¥ Salud de servicios locales"
    silent: true
    cmds:
      - echo "ğŸ  Salud local:"
      - curl -s http://localhost:8000/health || echo "âŒ Backend no responde"
      - curl -s http://localhost:3000/api/health || echo "âŒ Frontend no responde"

  health:aws:
    desc: "ğŸ¥ Salud de servicios AWS"
    silent: true
    cmds:
      - echo "â˜ï¸ Salud AWS:"
      - task: aws:ip
      - echo "Verificando endpoints AWS..."
      - curl -s http://$(aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text):8000/health || echo "âŒ Backend AWS no responde"

  ports:
    desc: "ğŸ”Œ Verificar puertos en uso"
    silent: true
    cmds:
      - echo "ğŸ”Œ Puertos en uso:"
      - lsof -i :3000 || echo "âœ… Puerto 3000 libre"
      - lsof -i :8000 || echo "âœ… Puerto 8000 libre"
      - lsof -i :5432 || echo "âœ… Puerto 5432 libre"
      - lsof -i :6379 || echo "âœ… Puerto 6379 libre"

  resources:
    desc: "ğŸ’¾ Uso de recursos del sistema"
    silent: true
    cmds:
      - echo "ğŸ’¾ Uso de recursos:"
      - podman stats --no-stream
      - echo ""
      - echo "ğŸ’¿ Espacio en disco:"
      - df -h

  # ===== AWS MANAGEMENT =====
  aws:start:
    desc: "â–¶ï¸ Iniciar instancia EC2"
    silent: true
    cmds:
      - echo "â–¶ï¸ Iniciando instancia AWS..."
      - aws ec2 start-instances --instance-ids {{.AWS_INSTANCE_ID}}
      - echo "â³ Esperando que la instancia estÃ© lista..."
      - aws ec2 wait instance-running --instance-ids {{.AWS_INSTANCE_ID}}
      - echo "âœ… Instancia iniciada"
      - task: aws:ip

  aws:stop:
    desc: "â¹ï¸ Detener instancia (ahorrar dinero)"
    silent: true
    cmds:
      - echo "â¹ï¸ Deteniendo instancia AWS..."
      - aws ec2 stop-instances --instance-ids {{.AWS_INSTANCE_ID}}
      - echo "âœ… Instancia detenida (ahorrando dinero)"

  aws:status:
    desc: "ğŸ“Š Estado de la instancia"
    silent: true
    cmds:
      - echo "ğŸ“Š Estado de instancia AWS:"
      - aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].{State:State.Name,IP:PublicIpAddress,Type:InstanceType,LaunchTime:LaunchTime}' --output table

  aws:ip:
    desc: "ğŸŒ Obtener IP pÃºblica"
    silent: true
    cmds:
      - echo "ğŸŒ IP pÃºblica:"
      - aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text

  aws:costs:
    desc: "ğŸ’° Ver informaciÃ³n de costos"
    silent: true
    cmds:
      - echo "ğŸ’° InformaciÃ³n de costos AWS:"
      - aws ce get-cost-and-usage --time-period Start=2024-01-01,End=$(date +%Y-%m-%d) --granularity MONTHLY --metrics BlendedCost --group-by Type=DIMENSION,Key=SERVICE

  aws:ssh:
    desc: "ğŸ”‘ Conectar SSH a la instancia"
    silent: true
    cmds:
      - echo "ğŸ”‘ Conectando SSH..."
      - ssh -i {{.SSH_KEY}} ubuntu@$(aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text)

  deploy:aws:
    desc: "ğŸš€ Desplegar a AWS"
    silent: true
    cmds:
      - echo "ğŸš€ Desplegando a AWS..."
      - task: aws:start
      - echo "â³ Esperando que la instancia estÃ© lista..."
      - sleep 30
      - echo "ğŸ“¦ Desplegando aplicaciÃ³n..."
      - ssh -i {{.SSH_KEY}} ubuntu@$(aws ec2 describe-instances --instance-ids {{.AWS_INSTANCE_ID}} --query 'Reservations[0].Instances[0].PublicIpAddress' --output text) "cd /opt/cactus-dashboard && docker-compose pull && docker-compose up -d"
      - echo "âœ… Despliegue completado"
      - task: aws:ip

  # ===== OAUTH Y AUTENTICACIÃ“N =====
  oauth:verify:
    desc: "ğŸ” Verificar configuraciÃ³n OAuth"
    silent: true
    cmds:
      - echo "ğŸ” Verificando configuraciÃ³n OAuth..."
      - test -n "$GOOGLE_CLIENT_ID" && echo "âœ… GOOGLE_CLIENT_ID configurado" || echo "âŒ GOOGLE_CLIENT_ID no configurado"
      - test -n "$GOOGLE_CLIENT_SECRET" && echo "âœ… GOOGLE_CLIENT_SECRET configurado" || echo "âŒ GOOGLE_CLIENT_SECRET no configurado"
      - test -n "$NEXTAUTH_URL" && echo "âœ… NEXTAUTH_URL configurado" || echo "âŒ NEXTAUTH_URL no configurado"

  oauth:update:
    desc: "ğŸ”„ Actualizar credenciales OAuth"
    silent: true
    cmds:
      - echo "ğŸ”„ Actualizando credenciales OAuth..."
      - echo "Por favor, actualiza las variables de entorno:"
      - echo "  GOOGLE_CLIENT_ID=tu_nuevo_client_id"
      - echo "  GOOGLE_CLIENT_SECRET=tu_nuevo_client_secret"
      - echo "  NEXTAUTH_URL=http://localhost:3000"

  oauth:diagnose:
    desc: "ğŸ” DiagnÃ³stico completo de OAuth"
    silent: true
    cmds:
      - echo "ğŸ” DiagnÃ³stico completo de OAuth..."
      - task: oauth:verify
      - echo ""
      - echo "ğŸ“‹ Verificando endpoints:"
      - curl -s http://localhost:3000/api/auth/providers || echo "âŒ Endpoint de providers no disponible"
      - echo ""
      - echo "ğŸ”§ ConfiguraciÃ³n NextAuth:"
      - test -f "cactus-wealth-frontend/.env.local" && echo "âœ… .env.local existe" || echo "âŒ .env.local no existe"

  oauth:test:
    desc: "ğŸ§ª Probar configuraciÃ³n OAuth"
    silent: true
    cmds:
      - echo "ğŸ§ª Probando configuraciÃ³n OAuth..."
      - task: oauth:verify
      - echo ""
      - echo "ğŸŒ Abriendo pÃ¡gina de login..."
      - open http://localhost:3000/auth/login || echo "âŒ No se pudo abrir el navegador"

  # ===== LIMPIEZA Y MANTENIMIENTO =====
  cleanup:
    desc: "ğŸ§¹ Limpieza completa (puertos + cachÃ©)"
    silent: true
    cmds:
      - echo "ğŸ§¹ Limpieza completa..."
      - task: cleanup:ports
      - task: cleanup:frontend
      - task: cleanup:backend
      - echo "âœ… Limpieza completada"

  cleanup:ports:
    desc: "ğŸ”Œ Limpiar puertos ocupados"
    silent: true
    cmds:
      - echo "ğŸ”Œ Limpiando puertos..."
      - |
        # Si la Podman Machine estÃ¡ corriendo, no matar procesos del host (evita matar gvproxy/qemu)
        if podman machine list 2>/dev/null | grep -q "cactus-dashboard.*Currently running"; then
          echo "â„¹ï¸ Podman Machine en ejecuciÃ³n. Saltando kill de puertos del host."
          echo "   Usa podman-compose down para liberar puertos gestionados por contenedores."
        else
          lsof -ti:3000 | xargs kill -9 2>/dev/null || echo "âœ… Puerto 3000 libre"
          lsof -ti:8000 | xargs kill -9 2>/dev/null || echo "âœ… Puerto 8000 libre"
          lsof -ti:5432 | xargs kill -9 2>/dev/null || echo "âœ… Puerto 5432 libre"
          lsof -ti:6379 | xargs kill -9 2>/dev/null || echo "âœ… Puerto 6379 libre"
        fi

  cleanup:frontend:
    desc: "ğŸ§¹ Limpiar cachÃ© del frontend"
    silent: true
    cmds:
      - echo "ğŸ§¹ Limpiando cachÃ© del frontend..."
      - cd cactus-wealth-frontend && rm -rf .next node_modules/.cache 2>/dev/null || echo "âœ… CachÃ© frontend limpio"

  cleanup:backend:
    desc: "ğŸ§¹ Limpiar cachÃ© del backend"
    silent: true
    cmds:
      - echo "ğŸ§¹ Limpiando cachÃ© del backend..."
      - cd cactus-wealth-backend && rm -rf __pycache__ .pytest_cache 2>/dev/null || echo "âœ… CachÃ© backend limpio"

  cleanup:docker:
    desc: "ğŸ³ Limpiar Podman (imÃ¡genes, contenedores)"
    silent: true
    cmds:
      - echo "ğŸ³ Limpiando Podman..."
      - podman system prune -f
      - podman volume prune -f
      - echo "âœ… Podman limpio"

  # ===== PODMAN =====
  podman:check:
    desc: "ğŸ³ Verificar Podman"
    silent: true
    cmds:
      - echo "ğŸ³ Verificando Podman..."
      - podman info >/dev/null 2>&1 && echo "âœ… Podman funcionando" || (echo "âŒ Podman no funciona" && exit 1)

  podman:ensure:
    desc: "ğŸ”§ Asegurar que Podman estÃ© disponible"
    silent: true
    cmds:
      - echo "ğŸ”§ Asegurando disponibilidad de Podman..."
      - |
        if ! podman machine list | grep -q "cactus-dashboard"; then
          echo "ğŸ“¦ Creando mÃ¡quina Podman..."
          podman machine init --cpus 4 --memory 8192 --disk-size 50 cactus-dashboard
        fi
      - |
        if ! podman machine list | grep -q "cactus-dashboard.*Currently running"; then
          echo "ğŸš€ Iniciando mÃ¡quina Podman..."
          podman machine start cactus-dashboard
        else
          echo "âœ… MÃ¡quina ya estÃ¡ ejecutÃ¡ndose"
        fi
      - echo "âœ… Podman disponible"

  podman:verify:
    desc: "âœ… Verificar configuraciÃ³n de Podman"
    silent: true
    cmds:
      - echo "âœ… Verificando configuraciÃ³n de Podman..."
      - task: podman:check
      - echo ""
      - echo "ğŸ“Š InformaciÃ³n de la mÃ¡quina:"
      - podman machine list
      - echo ""
      - echo "ğŸ”§ ConfiguraciÃ³n:"
      - podman system connection list
      - echo ""
      - echo "ğŸ’¾ Recursos disponibles:"
      - podman system df

  podman:status:
    desc: "ğŸ“Š Estado de la mÃ¡quina Podman"
    silent: true
    cmds:
      - echo "ğŸ“Š Estado de la mÃ¡quina Podman:"
      - podman machine list
      - echo ""
      - echo "ğŸ”§ Conexiones activas:"
      - podman system connection list

  podman:start:
    desc: "ğŸš€ Iniciar mÃ¡quina Podman"
    silent: true
    cmds:
      - echo "ğŸš€ Iniciando mÃ¡quina Podman..."
      - |
        if podman machine list | grep -q "cactus-dashboard.*Currently running"; then
          echo "âœ… MÃ¡quina ya estÃ¡ ejecutÃ¡ndose"
        else
          podman machine start cactus-dashboard
          echo "âœ… MÃ¡quina iniciada"
        fi
      - task: podman:status

  podman:stop:
    desc: "â¹ï¸ Detener mÃ¡quina Podman"
    silent: true
    cmds:
      - echo "â¹ï¸ Deteniendo mÃ¡quina Podman..."
      - podman machine stop cactus-dashboard
      - echo "âœ… MÃ¡quina detenida"

  podman:restart:
    desc: "ğŸ”„ Reiniciar mÃ¡quina Podman"
    silent: true
    cmds:
      - echo "ğŸ”„ Reiniciando mÃ¡quina Podman..."
      - task: podman:stop
      - task: podman:start

  podman:helper:install:
    desc: "ğŸ”— Instalar podman-mac-helper (Docker socket compatibility)"
    silent: true
    cmds:
      - echo "ğŸ”— Instalando podman-mac-helper..."
      - |
        HELPER="$(brew --prefix podman)/bin/podman-mac-helper";
        if [ -x "$HELPER" ]; then
          echo "Usando $HELPER";
        else
          echo "âŒ podman-mac-helper no encontrado";
          exit 1;
        fi
        if sudo -n "$HELPER" install; then
          echo "âœ… mac-helper instalado";
        else
          echo "âš ï¸  Se requiere sudo interactivo. Ejecuta manualmente: sudo $HELPER install";
          exit 0;
        fi
      - echo "ğŸ”„ Reiniciando mÃ¡quina Podman para aplicar cambios..."
      - podman machine stop cactus-dashboard || true
      - podman machine start cactus-dashboard
      - echo "âœ… podman-mac-helper instalado"

  podman:helper:status:
    desc: "ğŸ”— Estado de compatibilidad Docker API (mac-helper)"
    silent: true
    cmds:
      - |
        echo "ğŸ”— Verificando estado del socket Docker API...";
        if test -S /var/run/docker.sock; then
          echo "âœ… /var/run/docker.sock presente (compatibilidad activa)";
        else
          echo "â„¹ï¸ /var/run/docker.sock no estÃ¡ enlazado";
        fi
        if [ -z "$DOCKER_HOST" ]; then
          echo "ğŸ“Œ DOCKER_HOST actual: no definido";
        else
          echo "ğŸ“Œ DOCKER_HOST actual: $DOCKER_HOST";
        fi
        echo "ğŸ’¡ Si no estÃ¡ activo: task podman:helper:install"

  podman:helper:uninstall:
    desc: "ğŸ”— Desinstalar podman-mac-helper"
    silent: true
    cmds:
      - echo "ğŸ”— Desinstalando podman-mac-helper..."
      - |
        HELPER="$(brew --prefix podman)/bin/podman-mac-helper";
        if sudo -n "$HELPER" uninstall; then
          echo "âœ… mac-helper desinstalado";
        else
          echo "âš ï¸  Se requiere sudo interactivo. Ejecuta manualmente: sudo $HELPER uninstall";
          exit 0;
        fi
      - echo "ğŸ”„ Reiniciando mÃ¡quina Podman para aplicar cambios..."
      - podman machine stop cactus-dashboard || true
      - podman machine start cactus-dashboard
      - echo "âœ… podman-mac-helper desinstalado"

  podman:diagnose:
    desc: "ğŸ” DiagnÃ³stico completo de Podman"
    silent: true
    cmds:
      - echo "ğŸ” DiagnÃ³stico completo de Podman..."
      - task: podman:check
      - echo ""
      - echo "ğŸ“Š Estado de contenedores:"
      - podman ps -a
      - echo ""
      - echo "ğŸ’¾ Uso de recursos:"
      - podman system df
      - echo ""
      - echo "ğŸ”§ ConfiguraciÃ³n de red:"
      - podman network ls
      - echo ""
      - echo "ğŸ’¿ VolÃºmenes:"
      - podman volume ls

  podman:cleanup:
    desc: "ğŸ§¹ Limpiar recursos de Podman"
    silent: true
    cmds:
      - echo "ğŸ§¹ Limpiando recursos de Podman..."
      - podman system prune -f
      - podman volume prune -f
      - podman image prune -f
      - echo "âœ… Limpieza completada"

  podman:reset:
    desc: "ğŸ”„ Reset completo de Podman"
    silent: true
    cmds:
      - echo "ğŸ”„ Reset completo de Podman..."
      - echo "â¹ï¸ Intentando detener stack (si aplica)..."
      - '{{.PODMAN_COMPOSE}} -f {{.COMPOSE_FILE}} down || true'
      - task: podman:cleanup
      - podman machine stop cactus-dashboard 2>/dev/null || echo "âœ… MÃ¡quina ya detenida"
      - podman machine rm cactus-dashboard 2>/dev/null || echo "âœ… MÃ¡quina ya eliminada"
      - podman machine init --cpus 4 --memory 8192 --disk-size 50 cactus-dashboard
      - podman machine start cactus-dashboard
      - echo "âœ… Reset completado"

  # ===== DOCKER (COMPATIBILIDAD) =====
  docker:check:
    desc: "ğŸ³ Verificar Docker (alias de Podman)"
    silent: true
    cmds:
      - echo "ğŸ³ Verificando Docker (alias de Podman)..."
      - docker info >/dev/null 2>&1 && echo "âœ… Docker (Podman) funcionando" || (echo "âŒ Docker (Podman) no funciona" && exit 1)

  docker:diagnose:
    desc: "ğŸ” DiagnÃ³stico de Docker (alias de Podman)"
    silent: true
    cmds:
      - echo "ğŸ” DiagnÃ³stico de Docker (alias de Podman)..."
      - task: docker:check
      - echo ""
      - echo "ğŸ“Š Estado de contenedores:"
      - docker ps -a
      - echo ""
      - echo "ğŸ’¾ Uso de recursos:"
      - docker system df

  # ===== TESTING =====
  test:all:
    desc: "ğŸ§ª Ejecutar todos los tests"
    silent: true
    cmds:
      - echo "ğŸ§ª Ejecutando todos los tests..."
      - task: test:backend
      - task: test:frontend

  test:backend:
    desc: "ğŸ§ª Tests del backend"
    silent: true
    cmds:
      - echo "ğŸ§ª Tests del backend..."
      - cd cactus-wealth-backend && python -m pytest tests/ -v

  test:frontend:
    desc: "ğŸ§ª Tests del frontend"
    silent: true
    cmds:
      - echo "ğŸ§ª Tests del frontend..."
      - cd cactus-wealth-frontend && npm test

  test:integration:
    desc: "ğŸ§ª Tests de integraciÃ³n"
    silent: true
    cmds:
      - echo "ğŸ§ª Tests de integraciÃ³n..."
      - task: dev:stop
      - task: dev
      - sleep 30
      - cd cactus-wealth-backend && python -m pytest tests/integration/ -v

  test:e2e:
    desc: "ğŸ§ª Tests end-to-end"
    silent: true
    cmds:
      - echo "ğŸ§ª Tests end-to-end..."
      - cd cactus-wealth-frontend && npm run e2e

  # ===== UTILIDADES =====
  setup:
    desc: "âš™ï¸ ConfiguraciÃ³n inicial"
    silent: true
    cmds:
      - echo "âš™ï¸ ConfiguraciÃ³n inicial de CactusDashboard..."
      - task: setup:podman-compose
      - task: docker:check
      - echo "ğŸ“¦ Instalando dependencias..."
      - cd cactus-wealth-backend && pip install -r requirements.txt
      - cd cactus-wealth-frontend && npm install
      - echo "âœ… ConfiguraciÃ³n completada"

  setup:podman-compose:
    desc: "ğŸ“¦ Instalar y configurar podman-compose"
    silent: true
    cmds:
      - echo "ğŸ“¦ Verificando podman-compose..."
      - |
        if ! test -f "{{.PODMAN_COMPOSE}}"; then
          echo "ğŸ”§ Instalando podman-compose..."
          pip3 install podman-compose
          echo "âœ… podman-compose instalado"
        else
          echo "âœ… podman-compose ya estÃ¡ disponible"
        fi
      - echo "ğŸ”— Verificando funcionamiento..."
      - '{{.PODMAN_COMPOSE}} --version'

  validate:
    desc: "âœ… Validar configuraciÃ³n"
    silent: true
    cmds:
      - echo "âœ… Validando configuraciÃ³n..."
      - task: docker:check
      - task: oauth:verify
      - echo "âœ… ConfiguraciÃ³n vÃ¡lida"

  # ===== AYUDA =====
  help:
    desc: "â“ DocumentaciÃ³n completa"
    silent: true
    cmds:
      - echo "ğŸŒµ CactusDashboard - Sistema de Comandos TASK"
      - echo ""
      - echo "ğŸ“š DocumentaciÃ³n completa:"
      - echo "  DOCUMENTATION.md - GuÃ­a completa del proyecto"
      - echo ""
      - echo "ğŸš€ Comandos principales:"
      - echo "  task dev              - Iniciar desarrollo completo"
      - echo "  task aws:start        - Iniciar instancia AWS"
      - echo "  task logs             - Ver logs en vivo"
      - echo "  task debug            - DiagnÃ³stico completo"
      - echo ""
      - echo "â“ Para mÃ¡s ayuda:"
      - echo "  task --list           - Lista de todos los comandos"
      - echo "  task help:quick       - Ayuda rÃ¡pida"

  help:quick:
    desc: "âš¡ Ayuda rÃ¡pida (comandos esenciales)"
    silent: true
    cmds:
      - echo "âš¡ Comandos esenciales:"
      - echo ""
      - echo "ğŸš€ Desarrollo:"
      - echo "  task dev              - Iniciar desarrollo"
      - echo "  task dev:stop         - Detener desarrollo"
      - echo "  task logs             - Ver logs"
      - echo ""
      - echo "â˜ï¸ AWS:"
      - echo "  task aws:start        - Iniciar instancia"
      - echo "  task aws:stop         - Detener instancia"
      - echo "  task aws:status       - Ver estado"
      - echo ""
      - echo "ğŸ”§ Utilidades:"
      - echo "  task debug            - DiagnÃ³stico"
      - echo "  task cleanup          - Limpiar todo"
      - echo "  task help             - Ayuda completa"
